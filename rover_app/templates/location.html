<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ç¾åœ¨ä½ç½®</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB36CNwaL8r40mWu22gosRyYbr4-0FrCTg&callback=initMap" async defer></script>
</head>
<body class="green-bg">
    <header>
        <h1>ç¾åœ¨ã®å ´æ‰€</h1>
        <a href="{{ url_for('logout') }}" class="logout-button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
    </header>
    <div class="main-container">
        <div id="map"></div>
    </div>
    <div class="back-arrow">
        <a href="{{ url_for('top') }}">&lt;ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</a>
    </div>

<script>
    let map;
    let marker;

    // ãƒãƒƒãƒ—ã®åˆæœŸåŒ–
    function initMap() {
        const initialPosition = { lat: 35.6895, lng: 139.6917 }; // åˆæœŸä½ç½®ï¼ˆæ±äº¬é§…ãªã©ï¼‰
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 18,
            center: initialPosition,
        });
        marker = new google.maps.Marker({
            position: initialPosition,
            map: map,
        });
        connectWebSocket();
    }
    function connectWebSocket() {
        // PCã‚µãƒ¼ãƒãƒ¼ã®ãƒ–ãƒ©ã‚¦ã‚¶ç”¨ãƒãƒ¼ãƒˆ(8889)ã«æ¥ç¶š
        // (window.location.hostname ã¯ 'app.py' ãŒå‹•ã„ã¦ã„ã‚‹PCã®IP/ãƒ›ã‚¹ãƒˆå)
        const ws_uri = `ws://${window.location.hostname}:8889`;
        const ws = new WebSocket(ws_uri);
        const statusDiv = document.querySelector('header h1'); // ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ†ã‚’ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã«åˆ©ç”¨

        ws.onopen = () => {
            console.log("Map WebSocket connected to " + ws_uri);
            statusDiv.textContent = "ç¾åœ¨ã®å ´æ‰€ (ãƒ­ãƒ¼ãƒãƒ¼ã«æ¥ç¶šä¸­...)";
        };
        
        ws.onclose = () => {
            console.log("Map WebSocket disconnected.");
            statusDiv.textContent = "ç¾åœ¨ã®å ´æ‰€ (æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸ)";
            statusDiv.style.color = "red";
        };

        ws.onmessage = (event) => {
            // æ˜ åƒ(Blob)ã¯ç„¡è¦–ã—ã€JSON(ãƒ†ã‚­ã‚¹ãƒˆ)ã®ã¿ã‚’å‡¦ç†
            if (event.data instanceof Blob) {
                return;
            }

            try {
                const msg = JSON.parse(event.data);
                
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ 'gps_update' ã‚¿ã‚¤ãƒ—ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ¥ãŸã‚‰åœ°å›³ã‚’æ›´æ–°
                if (msg.type === 'gps_update' && msg.data) {
                    const newPos = { lat: msg.data[0], lng: msg.data[1] };
                    
                    // ãƒãƒ¼ã‚«ãƒ¼ã®ä½ç½®ã‚’æ›´æ–°
                    marker.setPosition(newPos);
                    // åœ°å›³ã®ä¸­å¿ƒã‚’ãƒãƒ¼ã‚«ãƒ¼ã«åˆã‚ã›ã‚‹
                    map.setCenter(newPos);
                    statusDiv.textContent = "ç¾åœ¨ã®å ´æ‰€ (ğŸ›°ï¸ æ•æ‰ä¸­)";
                    statusDiv.style.color = "white"; // è‰²ã‚’æˆ»ã™
                }
                // 'gps_status' (æœªæ•æ‰ã‚„åˆ‡æ–­) ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                else if (msg.type === 'gps_status') {
                    if(msg.data === "Fixing...") {
                        statusDiv.textContent = "ç¾åœ¨ã®å ´æ‰€ (è¡›æ˜Ÿã‚’æ¢ç´¢ä¸­...)";
                        statusDiv.style.color = "orange";
                    } else if(msg.data === "Disconnected") {
                        statusDiv.textContent = "ç¾åœ¨ã®å ´æ‰€ (GPSæœªæ¥ç¶š)";
                        statusDatal.style.color = "red";
                    }
                }
            } catch (e) {
                // JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
            }
        };

        ws.onerror = (error) => {
            console.error("Map WebSocket Error: ", error);
            statusDiv.textContent = "ç¾åœ¨ã®å ´æ‰€ (æ¥ç¶šã‚¨ãƒ©ãƒ¼)";
            statusDiv.style.color = "red";
        };
    }
</script>
</body>
</html>